//server
require("dotenv").config({ path: "/home/node/hello-world/.env" });

// local
// require("dotenv").config();

const OpenAI = require("openai");

const openai = new OpenAI({
  apiKey: process.env.DEEPSEEK_API_KEY,
  baseURL: "https://api.deepseek.com",
});

async function generateForecast(fullText) {
  console.log(
    "üì© –ü–æ–ª—É—á–µ–Ω —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞:",
    fullText.slice(0, 100)
  );
  if (!fullText) {
    return "";
  }
  const prompt = `
	–ù–∞–ø–∏—à–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–∞—Ç—á –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ—Ç —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ ${JSON.stringify(fullText)}. 
	–ü—Ä–æ–≥–Ω–æ–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
	- –ü—Ä–æ–≥–Ω–æ–∑ –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –≤ —Ç–µ–≥ <b>
	- –ü—Ä–æ–≥–Ω–æ–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ 10 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
	- –í–µ—Å—å –ø—Ä–æ–≥–Ω–æ–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ –¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤, –≤–∫–ª—é—á–∞—è –ø—Ä–æ–±–µ–ª—ã
	- –ù–µ –ø–∏—à–∏ —Å–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ.
	- –í—Å–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ø–æ —Å–º—ã—Å–ª—É, –∞ –≤ –∫–æ–Ω—Ü–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ —Å—Ç–æ—è—Ç—å —Ç–æ—á–∫–∞
	- –†–∞–∑–¥–µ–ª—è–π —Ç–µ–∫—Å—Ç –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∞–±–∑–∞—Ü—ã, –¥–µ–ª–∞–π –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –Ω–∏–º–∏ —Å –ø–æ–º–æ—â—å—é –¥–≤–æ–π–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫–∏ (\n\n)
	- –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏ –≥–ª—É–±–æ–∫–∏–º
	- –ß–µ–ª–æ–≤–µ—á–Ω—ã–º –∏ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º

	–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å—Ç–∏–ª—é:
	- –ò—Å–ø–æ–ª—å–∑—É–π –∂–∏–≤—É—é, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —Ä–µ—á—å
	- –ß–µ—Ä–µ–¥—É–π –¥–ª–∏–Ω–Ω—ã–µ –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
	- –î–æ–±–∞–≤–ª—è–π —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–µ –º–Ω–µ–Ω–∏–µ –∏ –∏–Ω—Å–∞–π—Ç—ã
	- –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏ –º–µ—Ç–∞—Ñ–æ—Ä—ã –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ
	- –ü—Ä–∏–≤–æ–¥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ —Ñ–∞–∫—Ç—ã

	–°—Ñ–æ—Ä–º–∏—Ä—É–π –æ—Ç–≤–µ—Ç –≤ HTML-—Ñ–æ—Ä–º–∞—Ç–µ. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Å–ª–µ–¥—É—é—â–∏–µ —Ç–µ–≥–∏:
	- <b> –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤

	–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏, –≤ —Ç–æ–º —á–∏—Å–ª–µ:
	- <html>, <h1>, <h2>, <h3>, <p>, <br> –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ.

	–ù–µ –¥–æ–±–∞–≤–ª—è–π –∏—Ç–æ–≥–æ–≤—ã–µ –ø–æ–¥—Å—á—ë—Ç—ã —Å–∏–º–≤–æ–ª–æ–≤, –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π markdown-—Ä–∞–∑–º–µ—Ç–∫—É, —Ç–∞–∫—É—é –∫–∞–∫ \`\`\`html –∏–ª–∏ –¥—Ä—É–≥–∏–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞.
	`;

  try {
    const chatCompletion = await openai.chat.completions.create({
      model: "deepseek-chat",
      messages: [{ role: "user", content: prompt }],
      temperature: 1.5,
      max_tokens: 500,
    });

    const forecast = chatCompletion.choices[0]?.message?.content?.trim() || "";
    console.log("+ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ–≥–Ω–æ–∑ –æ—Ç –ò–ò.");
    return forecast;
  } catch (error) {
    console.error("- –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞:", error.message);
    return "";
  }
}

module.exports = generateForecast;
